<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <title>Jamie's first A-Frame</title>

    <!-- import the webpage's stylesheet -->
    <link rel="stylesheet" href="/style.css" />

    <!-- import the webpage's javascript file -->
    <script src="/script.js" defer></script>

    <script>
      AFRAME.registerComponent("rotate-moon", {
        init: function() {},
        tick: function() {
          let rotation = this.el.getAttribute("rotation");
          rotation.y += 0.1;
          this.el.setAttribute("rotation", rotation);
        }
      });

      AFRAME.registerShader("custom-material-shader", {
        schema: {
          color: { type: "color", is: "uniform", default: "red" },
          opacity: { type: "number", is: "uniform", default: 1.0 },
          u_resolution: {
            type: "vec2",
            is: "uniform",
            default: new THREE.Vector2(1.0, 1.0)
          },
          u_time: { type: "number", is: "uniform", default: 1.0 }
        },
        raw: false,
        fragmentShader: `
              // Use medium precision.
              precision mediump float;


              uniform vec2 u_resolution;
              uniform float u_time;

              void main() {
                  vec2 st = gl_FragCoord.xy/u_resolution.xy;
                  st.x *= u_resolution.x/u_resolution.y;

                  vec3 color = vec3(0.);
                  color = vec3(abs(sin(5.0*3.14*u_time)),abs(sin(5.0*3.14*u_time)),abs(sin(3.14*u_time)));
                  gl_FragColor = vec4(color,1.0);
              }
              
            `
      });

      AFRAME.registerComponent("material-updater", {
        init: function() {
          this.u_time = 0;
          this.u_resolution = new THREE.Vector2(
            this.el.sceneEl.canvas.width,
            this.el.sceneEl.canvas.height
          );
          this.el.setAttribute("material", "u_resolution", this.u_resolution);
          console.log(this.u_resolution);

          var vertices = this.el.getObject3D("mesh").geometry.attributes
            .position.count;
          var vertexDisplacement = new Float32Array(vertices);
          for (var i = 0; i < vertexDisplacement.length; i++) {
            vertexDisplacement[i] = Math.sin(i);
          }

          this.el.getObject3D("mesh").geometry.addAttribute(
            "vertexDisplacement",
            new THREE.BufferAttribute(vertexDisplacement, 1)
          );
          
          var mesh = (this.mesh = this.el.getObject3D("mesh"));
          mesh.material = new THREE.ShaderMaterial({
            uniforms: {
              u_time: {
                value: 1.0
              }
            },

            fragmentShader: `
              // Use medium precision.
              precision mediump float;


              uniform float u_time;

              void main() {

                  vec3 color = vec3(0.);
                  color = vec3(1.0,abs(sin(3.14*u_time*0.99)),1.0);
                  gl_FragColor = vec4(color,1.0);
              }
              
            `
          });
          
        },

        tick: function(t, dt) {
          this.u_time++;
          this.el.setAttribute("material", "u_time", this.u_time);
          this.mesh.material.uniforms.u_time.value++;
        }
      });
    </script>
  </head>
  <body>
    <a-scene>
      <a-entity oculus-touch-controls="hand: left"></a-entity>
      <a-entity oculus-touch-controls="hand: right"></a-entity>

      <a-sky
        src="https://cdn.glitch.com/6cd24866-2086-438e-8da5-5ab5e75a5a7b%2Fstars_texture.jpg?v=1596487305133"
      ></a-sky>

      <a-sphere
        rotate-moon
        material="shader: custom-material-shader; color: blue; opacity: 0.7;"
        material-updater
        radius="2"
        segments-height="53"
        position="0 2 -5"
      ></a-sphere>
    </a-scene>
  </body>
</html>
